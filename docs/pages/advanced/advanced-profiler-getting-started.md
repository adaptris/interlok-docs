> **Summary:** Setting up Interlok for profiling.

**Since 4.0+**

This document will walk you through the setup and configuration to have Interlok generate basic profiling data.  There are other profiling documentation that will follow on from this one for specific needs.

## Prerequisites.

You will need a few extra Interlok libraries in your Interlok installations "lib" directory.
See our guide on creating a new installation using gradle [here](https://interlok.adaptris.net/interlok-docs/#/pages/overview/adapter-gradle).
Specifically, you will need to add the following libraries to your gradle build files dependency section;

```
  interlokRuntime ("com.adaptris:interlok-rest-base:$interlokVersion") { changing=true }
  interlokRuntime ("com.adaptris:interlok-rest-metrics-profiler:$interlokVersion") { changing=true }
  interlokRuntime ("com.adaptris:interlok-rest-metrics-jvm:$interlokVersion") { changing=true }
  interlokRuntime ("com.adaptris:interlok-rest-provider-prometheus:$interlokVersion") { changing=true }
  interlokRuntime ("com.adaptris:interlok-profiler:$interlokVersion") { changing=true }

  interlokJavadocs ("com.adaptris:interlok-rest-base:$interlokVersion:javadoc") { changing=true; transitive=false }
  interlokJavadocs ("com.adaptris:interlok-rest-metrics-profiler:$interlokVersion:javadoc") { changing=true; transitive=false }
  interlokJavadocs ("com.adaptris:interlok-rest-metrics-jvm:$interlokVersion:javadoc") { changing=true; transitive=false }
  interlokJavadocs ("com.adaptris:interlok-rest-provider-prometheus:$interlokVersion:javadoc") { changing=true; transitive=false }
  interlokJavadocs ("com.adaptris:interlok-profiler:$interlokVersion:javadoc") { changing=true; transitive=false }
```
Or of course if you're using the Interlok installer, simply select each of these components to install along side the core

### Interlok Setup

There are two kinds of metrics that Interlok can expose;
 - JVM metrics
 - Workflow processing

The JVM metrics will report on all things about the Java engine running Interlok, such as memory and CPU usage as well as detailed statistics that might be used to debug an environment.

The workflow processing metrics will show the number of messages processed/failed and the average speeds of all services, producers and workflows.

The first thing we will do is to enable both the JVM and workflow metrics in the bootstrap.properties.
Simply edit this file and the following two values to the __managementComponents__ property;
 - metrics-jvm
 - metrics-interlok

Like this;
```
managementComponents=jetty:jmx:metrics-jvm:metrics-interlok
```

And finally, we will need to add two flags to the JVM inside the Interlok start script.  The process of editing your start script may vary depending on your chosen deployment platform.  The flags we need to add is:
```
-javaagent:lib/aspectjweaver.jar
-Dorg.aspectj.weaver.loadtime.configuration=META-INF/profiler-aop.xml
```

A windows start script with these two switches might look like this (the last line being the important one);
```
setlocal ENABLEDELAYEDEXPANSION
set CLASSPATH=. 
set INTERLOK_HOME=C:\Adaptris\5.0 
set JAVA_HOME=C:\Java\Zulu\zulu-11\bin 
set CLASSPATH=%CLASSPATH%;%INTERLOK_HOME%\lib\*;%INTERLOK_HOME%\config  

%JAVA_HOME%\java -cp %CLASSPATH% -javaagent:lib/aspectjweaver.jar -Dorg.aspectj.weaver.loadtime.configuration=META-INF/profiler-aop.xml -jar ./lib/interlok-boot.jar
```

A docker compose file might look like this;
```
interlok: 
    image: adaptrislabs/interlok-docker-prometheus
    container_name: interlok-profiler
    hostname: interlok
    ports:
      - '8080:8080'
      - '5555:5555'
    environment:
      JVM_ARGS: -javaagent:lib/aspectjweaver.jar -Dorg.aspectj.weaver.loadtime.configuration=META-INF/profiler-aop.xml
```
And that's it!

Your now generating metrics for Interlok installation.

Your next step will be to consume those metrics and send them to a metrics processor.  One easy way to view the metrics is to use the kubernetes provider, you don't actually need kubernetes for this, but it will allow you to see the metrics being generated by triggering a HTTP request to a page hosted by Interlok itself.
And it's easy to setup; simply add the following to your __managementComponents__ property in your bootstrap.properties;
 - metrics-provider-prometheus

Like this;
```
managementComponents=jetty:jmx:metrics-jvm:metrics-interlok:metrics-provider-prometheus
```

Now using a browser navigate to __http://localhost:8080/prometheus/metrics__
Obviously switching out the host and port if needed.

You will be presented with a page listing all of the metrics for that moment in time.  if you need rolling statistics, simply make a request to that page every N seconds.


